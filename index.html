
}

function saveDB() { localStorage.setItem('nd_v9_db', JSON.stringify(db)); }

/* --- ADMIN POWER FUNCTIONS --- */
function updateAdminList() {
    const list = document.getElementById('user-list'); list.innerHTML = '';
    Object.values(db).forEach(u => {
        const row = document.createElement('div');
        row.className = 'user-row';
        
        let skinOptions = SKINS.map(s => `<option value="${s.id}">${s.n}</option>`).join('');

        row.innerHTML = `
            <div><b>${u.u}</b> | ${u.coins} C</div>
            <div class="admin-controls">
                <input type="number" id="amt-${u.u}" placeholder="Coin">
                <button class="btn-sml" style="background:var(--gold);color:black" onclick="giveCoin('${u.u}')">Kirim</button>
                <select id="skn-${u.u}" style="width: 80px;">${skinOptions}</select>
                <button class="btn-sml" style="background:var(--neon);color:black" onclick="giveSkin('${u.u}')">Beri</button>
                <button class="btn-sml" style="background:#ff3333" onclick="delUser('${u.u}')">X</button>
            </div>
        `;
        list.appendChild(row);
    });
}

function giveCoin(target) {
    const amt = parseInt(document.getElementById(`amt-${target}`).value);
    if(isNaN(amt)) return alert("Masukkan jumlah angka!");
    db[target].coins += amt;
    saveDB(); updateAdminList();
    alert(`Berhasil mengirim ${amt} koin ke ${target}`);
}

function giveSkin(target) {
    const skinId = parseInt(document.getElementById(`skn-${target}`).value);
    if(!db[target].owned.includes(skinId)) {
        db[target].owned.push(skinId);
        saveDB(); alert(`Skin diberikan ke ${target}`);
    } else {
        alert("User sudah punya skin ini");
    }
}

function delUser(target) {
    if(confirm(`Hapus akun ${target}?`)) { delete db[target]; saveDB(); updateAdminList(); }
}

/* --- GAMEPLAY --- */
function renderShop() {
    document.getElementById('u-n').innerText = user.u;
    document.getElementById('u-c').innerText = user.coins + " C";
    const g = document.getElementById('skin-grid'); g.innerHTML = '';
    SKINS.forEach(s => {
        let own = user.owned.includes(s.id);
        if(!own && s.cost === 0) return;
        let d = document.createElement('div'); d.className = `item ${user.cur === s.id ? 'active' : ''}`;
        let bg = s.c === 'rainbow' ? 'linear-gradient(red, blue)' : s.c;
        d.innerHTML = `<div class="pre" style="background:${bg}; border:${s.border?'1px solid '+s.border:'none'}"></div><div style="font-size:8px">${s.n}</div><div style="color:var(--gold)">${own?'PAKAI':s.cost}</div>`;
        d.onclick = () => { 
            if(own) user.cur=s.id; 
            else if(user.coins>=s.cost){ user.coins-=s.cost; user.owned.push(s.id); user.cur=s.id; }
            if(!user.isAdmin){ db[user.u]=user; saveDB(); }
            renderShop();
        };
        g.appendChild(d);
    });
}

let game = { running:false, px:0, py:0, tx:0, tilt:0, enemies:[], bullets:[], lastF:0, skor:0 };

function start() {
    nav('none');
    game = { ...game, running:true, px:cvs.width/2, py:cvs.height*0.8, tx:cvs.width/2, enemies:[], bullets:[], skor:0 };
}

function loop() {
    ctx.fillStyle = "rgba(2, 2, 5, 0.25)"; ctx.fillRect(0,0,cvs.width,cvs.height);
    if(game.running) {
        let s = SKINS.find(x => x.id === user.cur) || SKINS[0];
        game.px += (game.tx - game.px) * s.speed; game.tilt = (game.tx - game.px) * 0.1;
        if(Date.now() - game.lastF > s.firerate) { game.bullets.push({x:game.px, y:game.py-20, vip:s.id>=11}); playShootSound(s.id>=11); game.lastF = Date.now(); }
        game.bullets.forEach((b,i) => {
            b.y -= 15; ctx.fillStyle = b.vip ? "#00f2ff" : "#fff";
            ctx.fillRect(b.x-(b.vip?2:1), b.y, b.vip?4:2, 12);
            if(b.y < 0) game.bullets.splice(i,1);
        });
        if(Math.random() < 0.07) game.enemies.push({x:Math.random()*cvs.width, y:-20});
        game.enemies.forEach((e,i) => {
            e.y += (5 + game.skor/5000); ctx.fillStyle="#ff3333"; ctx.beginPath(); ctx.arc(e.x, e.y, 15, 0, Math.PI*2); ctx.fill();
            if(Math.hypot(game.px-e.x, game.py-e.y) < 25) {
                game.running = false; document.getElementById('final-skor').innerText = game.skor;
                if(!user.isAdmin){ user.coins+=Math.floor(game.skor/10); db[user.u]=user; saveDB(); }
                nav('scr-over');
            }
            game.bullets.forEach((b,bi) => { if(Math.hypot(b.x-e.x, b.y-e.y) < 22) { game.enemies.splice(i,1); game.bullets.splice(bi,1); game.skor+=100; } });
        });
        ctx.save(); ctx.translate(game.px, game.py); ctx.rotate(game.tilt);
        ctx.fillStyle = "orange"; ctx.fillRect(-4, 10, 8, s.id>=11?22:12);
        if(s.c==='rainbow'){ let g=ctx.createLinearGradient(-15,0,15,0); g.addColorStop(0,"red"); g.addColorStop(1,"blue"); ctx.fillStyle=g; }
        else ctx.fillStyle=s.c;
        ctx.beginPath(); ctx.moveTo(0,-25); ctx.lineTo(-20,10); ctx.lineTo(0,3); ctx.lineTo(20,10); ctx.closePath(); ctx.fill();
        if(s.border){ ctx.strokeStyle=s.border; ctx.lineWidth=3; ctx.stroke(); }
        ctx.restore();
        document.getElementById('skor-val').innerText = game.skor;
    }
    requestAnimationFrame(loop);
}

window.addEventListener('mousemove', e => game.tx = e.clientX);
window.addEventListener('touchmove', e => { game.tx = e.touches[0].clientX; e.preventDefault(); }, {passive:false});
cvs.width = window.innerWidth; cvs.height = window.innerHeight; loop();
</script>
</body>
</html>
